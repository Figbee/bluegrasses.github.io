<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>larachina02 学习笔记 - 罗亭的技术博客</title>
<link rel="shortcut icon" href="https://bluegrasses.github.io/favicon.ico">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css">
<link rel="stylesheet" href="https://bluegrasses.github.io/media/css/tailwind.css">
<link rel="stylesheet" href="https://bluegrasses.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="larachina02 学习笔记 - 罗亭的技术博客 - Atom Feed" href="https://bluegrasses.github.io/atom.xml">

    

  <meta name="description" content="汇总知识
模型关联括号
模型关联什么时候加括号，什么时候不加括号 ?

加括号是关系, 不加是对象或者对象集合

第二章: 舞台布置
字体图标
@fortawesome/fontawesome-free
载入样式
resources/sas..." />
  <meta property="og:title" content="larachina02 学习笔记 - 罗亭的技术博客">
  <meta property="og:description" content="汇总知识
模型关联括号
模型关联什么时候加括号，什么时候不加括号 ?

加括号是关系, 不加是对象或者对象集合

第二章: 舞台布置
字体图标
@fortawesome/fontawesome-free
载入样式
resources/sas..." />
  <meta property="og:type" content="articles">
  <meta property="og:url" content="https://bluegrasses.github.io/post/larachina02-xue-xi-bi-ji/" />
  <meta property="og:image" content="https://bluegrasses.github.io/images/avatar.png">
  <meta property="og:image:height" content="630">
  <meta property="og:image:width" content="1200">
  <meta name="twitter:title" content="larachina02 学习笔记 - 罗亭的技术博客">
  <meta name="twitter:description" content="汇总知识
模型关联括号
模型关联什么时候加括号，什么时候不加括号 ?

加括号是关系, 不加是对象或者对象集合

第二章: 舞台布置
字体图标
@fortawesome/fontawesome-free
载入样式
resources/sas...">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://bluegrasses.github.io/post/larachina02-xue-xi-bi-ji/">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
 
  
    <link rel="stylesheet" href="https://bluegrasses.github.io/media/css/prism-synthwave84.css">
  

  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
  
</head>

<body>
  <div class="antialiased flex flex-col min-h-screen" id="app">
    <a href="https://bluegrasses.github.io" class="fixed top-0 left-0 mt-4 bg-black text-white dark:text-gray-700 dark:bg-yellow-50 dark:hover:bg-black dark:hover:text-white inline-flex p-2 pl-8 hover:text-gray-700 hover:bg-yellow-50 font-bold z-10 transition-fast animated fadeInLeft">
      罗亭的技术博客
    </a>
    <div class="max-w-4xl w-full mx-auto">
      <div class="shadow-box bg-white dark:bg-gray-600 rounded-lg pt-32 md:pt-64 px-4 md:px-8 pb-8 animated fadeIn mb-8">
        <h1 class="text-5xl font-semibold leading-normal pb-8 mb-8 border-b-8 border-gray-700">
          larachina02 学习笔记
        </h1>
        
        <div class="mb-8 flex flex-wrap">
          <div class="text-gray-400 text-sm mr-4">2020-11-02 · 32 min read</div>
          
            <a href="https://bluegrasses.github.io/tag/dQ2EWYbyS/" class="text-gray-700 text-sm border-b-2 border-dotted border-gray-200 hover:border-gray-600 transition-all duration-100 inline-flex mr-2">
              <i class="ri-hashtag"></i>
              laravel
            </a>
          
        </div>
        <div class="markdown mb-8" v-pre>
          <h2 id="汇总知识">汇总知识</h2>
<h3 id="模型关联括号">模型关联括号</h3>
<p>模型关联什么时候加括号，什么时候不加括号 ?</p>
<blockquote>
<p>加括号是关系, 不加是对象或者对象集合</p>
</blockquote>
<h2 id="第二章-舞台布置">第二章: 舞台布置</h2>
<h3 id="字体图标">字体图标</h3>
<p><a href="https://www.npmjs.com/package/@fortawesome/fontawesome-free">@fortawesome/fontawesome-free</a></p>
<h4 id="载入样式">载入样式</h4>
<p>resources/sass/app.scss</p>
<pre><code class="language-php">// Fontawesome
@import '~@fortawesome/fontawesome-free/scss/fontawesome';
@import '~@fortawesome/fontawesome-free/scss/regular';
@import '~@fortawesome/fontawesome-free/scss/solid';
@import '~@fortawesome/fontawesome-free/scss/brands';
</code></pre>
<h2 id="第三章-用户中心">第三章: 用户中心</h2>
<h3 id="guest使用">@guest使用</h3>
<pre><code class="language-html">@guest
&lt;li&gt;登录&lt;/li&gt;
&lt;li&gt;注册&lt;/li&gt;
@else
个人中心
编辑资料
@endguest
</code></pre>
<h3 id="验证码">验证码</h3>
<p><code>mewebstudio/captcha</code></p>
<blockquote>
<p>In Windows, you'll need to include the GD2 DLL <code>php_gd2.dll</code> in php.ini. And you also need include <code>php_fileinfo.dll</code>and <code>php_mbstring.dll</code> to fit the requirements of <code>mews/captcha</code>'s dependencies.</p>
</blockquote>
<p>基本使用</p>
<pre><code class="language-html">&lt;img src=&quot;{{captcha_src('flat')}}&quot;&gt;
</code></pre>
<h3 id="邮箱验证">邮箱验证</h3>
<ol>
<li>修改user模型</li>
</ol>
<pre><code class="language-php">use Illuminate\Auth\MustVerifyEmail as MustVerifyEmailTrait;
use Illuminate\Contracts\Auth\MustVerifyEmail as MustVerifyEmailContract;
class User extends Authenticatable implements MustVerifyEmailContract
{
	use Notifiable, MustVerifyEmailTrait;
</code></pre>
<ol start="2">
<li>
<p>强制用户认证</p>
<p>(1) 建立中间件</p>
</li>
</ol>
<pre><code class="language-php">// app\Http\Middleware\EnsureEmailIsVerified.php
class EnsureEmailIsVerified
{
    public function handle($request, Closure $next)
    {
        // 三个判断：
        // 1. 如果用户已经登录
        // 2. 并且还未认证 Email
        // 3. 并且访问的不是 email 验证相关 URL 或者退出的 URL。

        if($request-&gt;user()&amp;&amp;!$request-&gt;user()-&gt;hasVerifiedEmail()&amp;&amp;!$request-&gt;is('email/*','logout')){
            //判断是不是json响应
            return  $request-&gt;expectsJson()?abort(403,'Your email address is not verified.'):redirect()-&gt;route('verification.notice');
        }
        return $next($request);
    }
}
</code></pre>
<p>(2) 注册中间件</p>
<pre><code class="language-php">// app/Http/Kernel.php
    protected $middlewareGroups = [
    'web' =&gt; [
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        //注意需要在startSession中间件之后
        \App\Http\Middleware\EnsureEmailIsVerified::class, 
</code></pre>
<h3 id="事件和监听器基本流程">事件和监听器基本流程</h3>
<blockquote>
<p>应用场景:邮箱认证后的消息提示</p>
</blockquote>
<h4 id="存放目录">存放目录</h4>
<p>事件类存放在app/Events</p>
<p>事件类的监听器存放在app/Listeners中.</p>
<h4 id="注册事件和监听器">注册事件和监听器</h4>
<p><code>EventServiceProvider</code></p>
<pre><code class="language-php">protect $listen=[
  'App\Events\OrderShipped' =&gt; [
          'App\Listeners\SendShipmentNotification',
      ],
]
</code></pre>
<h4 id="生成事件监听器">生成事件&amp;监听器</h4>
<pre><code class="language-php">php artisan event:generate
</code></pre>
<h4 id="定义事件和监听器">定义事件和监听器</h4>
<p><code>定义事件</code></p>
<pre><code class="language-php">namespace App\Events;
use App\Order;
use Illuminate\Queue\SerializesModels;
class OrderShipped
{
    use SerializesModels;
    public $order;
    public function __construct(Order $order)
    {
        $this-&gt;order = $order;
    }
}
</code></pre>
<p><code>定义监听器</code></p>
<pre><code class="language-php">namespace App\Listeners;
use App\Events\OrderShipped;
class SendShipmentNotification
{
    public function __construct()
    {
    }
    /**
     * 处理事件。
     * @param  \App\Events\OrderShipped  $event
     * @return void
     */
    public function handle(OrderShipped $event)
    {
        // 使用 $event-&gt;order 来访问 order …
    }
}
</code></pre>
<h4 id="分发事件">分发事件</h4>
<pre><code class="language-php">class OrderController extends Controller
{
    /**
     * 将传递过来的订单发货。
     * @param  int  $orderId
     * @return Response
     */
    public function ship($orderId)
    {
        $order = Order::findOrFail($orderId);
        // 订单发货逻辑…
        event(new OrderShipped($order));
    }
}
</code></pre>
<h3 id="密码重置提示">密码重置提示</h3>
<p>涉及知识点 , trait方法重写</p>
<h2 id="第四章-用户中心">第四章: 用户中心</h2>
<h3 id="unique-验证规则">unique 验证规则</h3>
<blockquote>
<p>场景: 用户在编辑自身资料时, 如未修改唯一字段email, 提交时会报错email已存在. 需要在unique判断时排除自身</p>
</blockquote>
<pre><code class="language-php">//unique 第一个参数表名 第二参数字段名 第三个参数排除的数据
'email'=&gt;'requried|unique:users,eamil,'.\Auth::id()
</code></pre>
<h3 id="中文显示友好时间戳">中文显示友好时间戳</h3>
<p>基本操作</p>
<pre><code class="language-php">$user-&gt;created_at-&gt;diffForHumans()
</code></pre>
<blockquote>
<p>Carbon 是 php知名的时间和日期扩展,laravel 将其默认集成到框架中.diffForHumans()就是carbon对象提供的方法,默认情况下是英文的.</p>
</blockquote>
<p>修改为中文</p>
<pre><code class="language-php">app/Providers/AppServiceProvider.php
public function boot(){	
    \Carbon\Carbon::setLocale('zh');
}
</code></pre>
<h3 id="头像上传">头像上传</h3>
<h4 id="图片验证规则">图片验证规则</h4>
<pre><code class="language-php">'avatar'=&gt;'mimes:jpeg,bmp,png,gif|dimensions:min_width=208,min_heigth=208'
</code></pre>
<h4 id="裁剪图片">裁剪图片</h4>
<p>用户有时候会上传分辨率较大的图片,图片太大会拖慢页面的加载速度,所以接下来我们将对此进行优化.</p>
<p>插件名称: Intervention/image</p>
<p>https://github.com/Intervention/image</p>
<h3 id="个人资料编辑存在的问题">个人资料编辑存在的问题</h3>
<h4 id="1-游客限制">1. 游客限制</h4>
<p>解决方法: 中间件</p>
<pre><code class="language-php">public function __construct(){
    $this-&gt;middleware('auth');
}
</code></pre>
<h4 id="2修改别人的资料平行权限">2.修改别人的资料(平行权限)</h4>
<p>解决方法: 策略</p>
<p>(1) 生成策略,编写规则</p>
<p>(2) 注册策略</p>
<p>(3) 使用策略授权动作</p>
<h2 id="第五章-帖子列表">第五章 帖子列表</h2>
<p>建立模型同时建立数据迁移文件 -m 参数</p>
<pre><code class="language-php">php artisan make:model Models/Category -m
</code></pre>
<h3 id="初始化数据">初始化数据</h3>
<blockquote>
<p>用数据迁移来解决初始化数据,而不是使用模型工厂factory</p>
<p>用数据迁移来初始化数据</p>
<p>用模型工厂来生成测试数据</p>
</blockquote>
<p>解决方法: 数据迁移</p>
<p>我们定义的命名规范为seed_ (数据库名称) _data</p>
<pre><code class="language-php">php artisan make:migration seed_categories_data
</code></pre>
<p>数据迁移文件</p>
<pre><code class="language-php">public function up()
{
    $categories = [
        [
            'name' =&gt; '分享',
            'description' =&gt; '分享创造,分享发现',
        ],
        [
            'name' =&gt; '教程',
            'description' =&gt; '开发技巧,推荐扩展包等',
        ]
    ];
    //
    DB::table('categories')-&gt;insert($categories);
}

public function down()
{
    //
    DB::table('categories')-&gt;truncate();
}
</code></pre>
<h3 id="代码生成器">代码生成器</h3>
<p>laravel 项目开发规范</p>
<p>https://learnku.com/docs/laravel-specification/5.5</p>
<p>插件名称: <code>summerblue/generator</code></p>
<h4 id="使用案例">使用案例</h4>
<pre><code class="language-php">//schema 后面的参数是数据库的字段描述
php artisan make:scaffold Topic --schema=&quot;name:string:index,description:text:nullable,subscriber_count:integer:unsigned:default(0)&quot;
</code></pre>
<h4 id="生成的代码">生成的代码</h4>
<ol>
<li>生成数据库迁移文件</li>
<li>创建数据工厂文件 TopicFactory.php</li>
<li>创建数据填充文件 TopicTableSeeder.php</li>
<li>创建模型基类文件和数据模型 Model.php Topic.php</li>
<li>创建控制 TopicsController.php</li>
<li>创建表单请求的基类文件 Request.php 并创建TopicRequest.php验证类</li>
<li>创建模型时间监控器,并在AppServiceProvider中注册 TopicObserver</li>
<li>创建授权策略基类 Policy.php 同时创建话题授权类TopicPolicy.php，并在AuthServiceProvider 中注册</li>
<li>在web.php中更新路由, 新增Topics资源路由</li>
<li>新建符合资源控制器的三个话题视图文件,并存放于resources/views/topics 目录;</li>
<li>执行数据库迁移命令 artisan migrate</li>
<li>执行composer dump-autoload 来生成classmap</li>
</ol>
<h3 id="git-使用案例">git 使用案例</h3>
<pre><code class="language-php">//撤销所有文件修改操作
git checkout .
//删除文件,删除add还是commit,不确定?
//-f 强制清理文件的设置 -d 连文件夹也删除
git clean -f -d
</code></pre>
<h3 id="数据填充">数据填充</h3>
<blockquote>
<p>Faker 假数据生成库</p>
<p>fzaninotto/faker</p>
</blockquote>
<p>生成laravel 的时间戳</p>
<p>'create_at'=&gt;<span class='katex-error' title='ParseError: KaTeX parse error: Double superscript at position 15: faker-&gt;data.&#039; &#039;̲.'>faker-&gt;data.&#039; &#039;.</span>faker-&gt;time;</p>
<h4 id="数据填充的基本流程">数据填充的基本流程</h4>
<ol>
<li>
<p>数据模型 Topic.php</p>
</li>
<li>
<p>数据工厂 database/factories/UserFactory.php</p>
</li>
<li>
<p>数据填充 database/seeds/UsersTableSeeder.php</p>
</li>
<li>
<p>注册数据填充 database/seeds/DatabaseSeeder.php</p>
</li>
</ol>
<p>使用案例:</p>
<ol>
<li>建立模型工厂</li>
</ol>
<pre><code class="language-php">// 1. UserFactory.php
$factory-&gt;define(App\Models\User::class, function (Faker $faker) {
    $data_time=$faker-&gt;date.' '.$faker-&gt;time;
    return [
        'name' =&gt; $faker-&gt;name,
        'email' =&gt; $faker-&gt;unique()-&gt;safeEmail,
        'email_verified_at' =&gt; now(),
        'password' =&gt; bcrypt('welcome'), // secret
        'remember_token' =&gt; str_random(10),
        'userinfo'=&gt;$faker-&gt;sentence(),
        'created_at'=&gt;$data_time,
        'updated_at'=&gt;$data_time,
    ];
}); 
</code></pre>
<ol start="2">
<li>建立seeder</li>
</ol>
<pre><code class="language-php">// 2. UsersTableSeeder.php
    public function run()
    {
        //获取faker实例
        $faker=app(Faker\Generator::class);
        $avatars=[
'https://iocaffcdn.phphub.org/uploads/images/201710/14/1/xAuDMxteQy.png',
'https://iocaffcdn.phphub.org/uploads/images/201710/14/1/ZqM7iaP4CR.png',
'https://iocaffcdn.phphub.org/uploads/images/201710/14/1/NDnzMutoxX.png',
        ];
        //生成数据集合 times为生成数量 make生成
        $users=factory(\App\Models\User::class)-&gt;times(10)-&gt;make()-&gt;each(function($user,$index) use($faker,$avatars){
            //从头像中随机取出一个并赋值
            $user-&gt;avatar=$faker-&gt;randomElement($avatars);
        });
        //让隐藏字段可见, 并将数据集合转换为数值
        $user_array=$users-&gt;makeVisible(['password','remember_token'])-&gt;toArray();
        //插入到数据库中
        \App\Models\User::insert($user_array);

        //单独更新第一个用户的数据
        $user=\App\Models\User::find(1);
        $user-&gt;name='admin';
        $user-&gt;email='admin@126.com';
        $user-&gt;avatar='https://iocaffcdn.phphub.org/uploads/images/201710/14/1/ZqM7iaP4CR.png';
        $user-&gt;save();
    }
</code></pre>
<ol start="3">
<li>在DatabaseSeeder中注册seeder</li>
</ol>
<pre><code class="language-php">// DatabaseSeeder.php
use Illuminate\Database\Seeder;
class DatabaseSeeder extends Seeder
{
    public function run()
    {
        $this-&gt;call(UsersTableSeeder::class);
    }
}
</code></pre>
<ol start="4">
<li>
<p>执行填充</p>
<pre><code class="language-php">php artisan migrate:refresh --seed
</code></pre>
</li>
</ol>
<h3 id="懒加载">懒加载</h3>
<p>解决n+1 的问题</p>
<pre><code class="language-php">// n+1 产生的场景
&lt;ul class=&quot;media-list&quot;&gt;
@foreach($topics as $topic)
{{$topic-&gt;user-&gt;name}}
{{$topic-&gt;category-&gt;name}}
@endforeach
&lt;/ul&gt;

 解决:
//with 懒加载 in语句
$topics=Topic::with('user','category')-&gt;paginate();
执行sql 语句:
select * form `user` where `user`.`id` in (1,2,4,5,6);

</code></pre>
<h3 id="标题模板三元表达式">标题模板三元表达式</h3>
<pre><code class="language-php">@section('title', isset($category)?$category-&gt;name:'话题列表')
</code></pre>
<h3 id="导航栏-active-类设置">导航栏 active 类设置</h3>
<h4 id="插件名称">插件名称</h4>
<p><code>letrunghieu/active</code></p>
<pre><code class="language-php">composer require &quot;hieu-le/active:~3.5&quot;
</code></pre>
<h4 id="基础语法">基础语法</h4>
<ol>
<li>if_route() - 判断当前对应的路由是否是指定的路由；</li>
<li>if_route_param() - 判断当前的 url 有无指定的路由参数。</li>
<li>if_query() - 判断指定的 GET 变量是否符合设置的值；</li>
<li>if_uri() - 判断当前的 url 是否满足指定的 url；</li>
<li>if_route_pattern() - 判断当前的路由是否包含指定的字符；</li>
<li>if_uri_pattern() - 判断当前的 url 是否含有指定的字符；</li>
</ol>
<h4 id="使用案例-2">使用案例</h4>
<p>案例1 :</p>
<pre><code class="language-php+html">/**设置 激活类
 * @param $routerName 路由名称
 * @param $param 地址栏参数
 * @param $param_id 参数值(id)
 * @return string 成功返回类名active,否则为''.
 */
function set_active_class($routerName,$param,$param_id)
{
    return active_class((if_route($routerName)&amp;&amp;if_route_param($param,$param_id)));
}

使用:
&lt;li class=&quot;nav-item {{active_class(if_route('topics.index'))}}&quot;&gt;
    &lt;a class=&quot;nav-link&quot; href=&quot;{{route('topics.index')}}&quot;&gt;话题 &lt;span class=&quot;sr-only&quot;&gt;(current)&lt;/span&gt;&lt;/a&gt;
&lt;/li&gt;
&lt;li class=&quot;nav-item {{set_active_class('categories.show','category',1)}}&quot;&gt;
    &lt;a class=&quot;nav-link&quot; href=&quot;{{route('categories.show',1)}}&quot;&gt;分享&lt;/a&gt;
&lt;/li&gt;
</code></pre>
<p>案例2 :</p>
<pre><code class="language-html">//if_query 判断参数order是否值为recent
&lt;li class=&quot;nav-item&quot;&gt;&lt;a class=&quot;nav-link {{active_class(!if_query('order','recent'))}}&quot; href=&quot;{{Request::url()}}?order=default&quot;&gt;最后回复&lt;/a&gt;&lt;/li&gt;

&lt;li class=&quot;nav-item&quot;&gt;&lt;a class=&quot;nav-link {{active_class(if_query('order','recent'))}}&quot; href=&quot;{{Request::url()}}?order=recent&quot;&gt;最新发布&lt;/a&gt;&lt;/li&gt;


</code></pre>
<h3 id="模板include变量分配">模板include变量分配</h3>
<blockquote>
<p>场景: 用户中心的文章列表</p>
</blockquote>
<pre><code class="language-html">@include('user._topics',['topics'=&gt;$user-&gt;topics()-&gt;recent()-&gt;paginate(5)])
</code></pre>
<h2 id="第六章-帖子curd">第六章 帖子CURD</h2>
<h3 id="模型观察器处理摘要">模型观察器处理摘要</h3>
<h4 id="eloquent-事件">Eloquent 事件</h4>
<table>
<thead>
<tr>
<th>事件</th>
<th>触发时机</th>
</tr>
</thead>
<tbody>
<tr>
<td>creating</td>
<td>当一个新模型被初次保存将会触发</td>
</tr>
<tr>
<td>created</td>
<td>当一个新模型被初次保存将会触发</td>
</tr>
<tr>
<td>updated</td>
<td>如果一个模型已经存在于数据库且调用了save方法</td>
</tr>
<tr>
<td>updating</td>
<td>如果一个模型已经存在于数据库且调用了save方法</td>
</tr>
<tr>
<td>saving</td>
<td>保存到数据库后触发（插入/更新之后，无论插入还是更新都会触发）</td>
</tr>
<tr>
<td>saved</td>
<td>保存到数据库后触发（插入/更新之后，无论插入还是更新都会触发）</td>
</tr>
</tbody>
</table>
<h4 id="应用场景">应用场景</h4>
<blockquote>
<p>摘要根据文章内容自动生成</p>
</blockquote>
<pre><code class="language-php">//观察器
class TopicObserver
{

    public function saving(Topic $topic)
    {
        $topic-&gt;excerpt=make_excerpt($topic-&gt;body);
    }
}

//helpers.php 函数
/**
 * 生成摘要函数
 * @param $value  生成摘要的值
 * @param int $length  生成摘要的长度
 * @return string
 */
function make_excerpt($value,$length=200)
{
    $excerpt=trim(preg_replace('/\r\n|\r|\n+/','',strip_tags($value)));
    return str_limit($excerpt,$length);
}

/*注册观察器
app/Providers/EventServiceProvider.php
*/
public function boot()
{
    parent::boot();
    Topic::observe(TopicObserver::class);
}
</code></pre>
<h3 id="simditor-编辑器">Simditor 编辑器</h3>
<h4 id="安装">安装</h4>
<p>下载simditor压缩包</p>
<p>将下载的 simditor.css 放置于 resources/editor/css 文件夹，将 hotkeys.js , odule.js ,simditor.js , uploader.js 四个文件放置于 resources/editor/js 文件夹中</p>
<pre><code class="language-php">//复制目录到public目录
mix.js('resources/js/app.js', 'public/js')
.sass('resources/sass/app.scss', 'public/css')
.copyDirectory('resources/editor/js', 'public/js')
.copyDirectory('resources/editor/css', 'public/css')
</code></pre>
<h4 id="加载">加载</h4>
<pre><code class="language-javascript">@section('styles')
 &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;{{ asset('css/simditor.css') }}&quot;&gt;
@endsection

@section('scripts')
 &lt;script type=&quot;text/javascript&quot; src=&quot;{{ asset('js/module.js') }}&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;{{ asset('js/hotkeys.js') }}&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;{{ asset('js/uploader.js') }}&quot;&gt;&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;{{ asset('js/simditor.js') }}&quot;&gt;&lt;/script&gt;
 &lt;script&gt;
 $(document).ready(function() {
 var editor = new Simditor({
     //#editor为textarea 的id值
 textarea: $('#editor'),
 });
 });
 &lt;/script&gt;
@endsection
</code></pre>
<h4 id="图片上传">图片上传</h4>
<pre><code class="language-JavaScript">//前台配置    
&lt;script&gt;
        $(document).ready(function () {
            var editor = new Simditor({
                textarea: $('#editor'),
                upload: {
                    url: '{{route('topics.upload_image')}}',
                    params: {_token: '{{csrf_token()}}'},
                    //服务器获取图片的键值
                    fileKey: 'upload_file',
                    //最多只能同时上传3张图片
                    connectionCount: 3,
                    leaveConfirm: '文件上传中,关闭此页面将取消上传'
                },
				//是否允许粘贴
                pasteImage:true,
            });
        });
    &lt;/script&gt;
</code></pre>
<h3 id="xss-安全漏洞">xss 安全漏洞</h3>
<p>HTMLPurifier</p>
<p>HTMLPurifier for Laravel(<a href="https://github.com/mewebstudio">mewebstudio</a>/Purifier)</p>
<p>插件名称 : mewebstudio/Purifier</p>
<p>插件地址 : https://github.com/mewebstudio/Purifier</p>
<h4 id="安装-2">安装</h4>
<pre><code class="language-php">composer require mews/purifier
</code></pre>
<p>发布配置文件</p>
<pre><code class="language-php">php artisan vendor:publish --provider=&quot;Mews\Purifier\PurifierServiceProvider&quot;
</code></pre>
<h4 id="配置">配置</h4>
<pre><code class="language-php">'user_topic_body' =&gt; [
    'HTML.Doctype' =&gt; 'XHTML 1.0 Transitional',
    'HTML.Allowed' =&gt; 'div,b,strong,i,em,u,a[href|title],ul,ol,li,p[style],br,span[style],img[width|height|alt|src]',
    'CSS.AllowedProperties' =&gt; 'font,font-size,font-weight,font-style,font-family,text-decoration,padding-left,color,background-color,text-align',
    'AutoFormat.AutoParagraph' =&gt; true,
    'AutoFormat.RemoveEmpty' =&gt; true,
],
</code></pre>
<h4 id="使用">使用</h4>
<pre><code class="language-php">//user_topic_body 是上面配置项设置的键名
$topic-&gt;body=clean($topic-&gt;body,'user_topic_body');
</code></pre>
<h4 id="xss-注入测试">xss 注入测试</h4>
<blockquote>
<p>富文本器可以对部分安全进行转义,但是提交内容并不一定通过浏览器进行, 下面是通过谷歌浏览器控制台进行的一个简单的注入案例</p>
</blockquote>
<p>在谷歌浏览器控制台 console中键入下面代码:</p>
<p>//注意网址 token需要替换成自己的</p>
<p><strong>token 如何查看:</strong></p>
<p>查看网页源代码:</p>
<figure data-type="image" tabindex="1"><img src="assets/1553565430564.png" alt="1553565430564" loading="lazy"></figure>
<pre><code class="language-php">fetch(&quot;http://larachina02.com/topics&quot;, {&quot;headers&quot;:{&quot;content-type&quot;:&quot;application/x-www-form-urlencoded&quot;,&quot;upgrade-insecure-requests&quot;:&quot;1&quot;},&quot;body&quot;:&quot;_token=RiqfIdepmYfymLBuvh5dEJxQI1vO3vrgGYdCb2gv&amp;title=dangerous%20content+&amp;category_id=2&amp;body=%3Cscript%3Ealert%28%27%E5%AD%98%E5%9C%A8%20XSS%20%E5%AE%89%E5%85%A8%E5%A8%81%E8%83%81%EF%BC%81%27%29%3C%2Fscript%3E&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;mode&quot;:&quot;cors&quot;});
</code></pre>
<p>上面代码会自动插入一片注入文章,点开该文章会有弹窗</p>
<h3 id="seo-友好的url">seo 友好的url</h3>
<blockquote>
<p>释义的 URL 有助于搜索引擎优化（SEO），本章节我们将开发自动生成 SEO 友好 URL 的功能。当用户提交发布话题的<br>
表单时，程序将调用 接口将话题标题翻译为英文，并储存于字段 slug 中。显示时候将 Slug 在 URL 中体现<br>
出来，假如话题标题为『Slug 翻译测试』的 URL 是：</p>
<p>http://larabbs.com/topics/119</p>
<p>加入 Slug 后 SEO 友好的链接为</p>
<p>http://larabbs.com/topics/119/slug-translation-test</p>
</blockquote>
<h4 id="安装的插件">安装的插件</h4>
<p><code>guzzlehttp/Guzzle</code></p>
<p>Guzzle库是一套强大的 PHP HTTP 请求套件，我们使用 Guzzle 的 HTTP 客户端来请求 接口。</p>
<p><code>overtrue\PinYin</code></p>
<p>PinYin是安正超开发的，基于cc-cedict 词典的中文转拼音工具，是一套优质的汉字转拼音解决方案。我们使用<br>
PinYin 来作为翻译的后备计划，当百度翻译 API 不可用时，程序会自动使用 PinYin 汉字转拼音方案来生成 Slug。</p>
<h4 id="注册百度翻译开放平台">注册百度翻译开放平台</h4>
<p>http://api.fanyi.baidu.com/api/trans/product/index</p>
<h4 id="翻译调用">翻译调用</h4>
<pre><code class="language-php">class TopicObserver
{

    public function saving(Topic $topic)
    {
        //入库时自动过滤
        $topic-&gt;body=clean($topic-&gt;body,'user_topic_body');
        //自动生成摘录
        $topic-&gt;excerpt=make_excerpt($topic-&gt;body);
        //seo 如slug字段无内容,即使使用翻译器对title进行翻译
        if(!$topic-&gt;slug){
            $topic-&gt;slug=app(SlugTranslateHandler::class)-&gt;translate($topic-&gt;title);
        }
    }
}
</code></pre>
<h3 id="laravel队列">laravel队列</h3>
<h4 id="队列步骤">队列步骤</h4>
<ol>
<li>配置队列安装驱动包</li>
<li>生成失败任务表</li>
<li>生成任务类</li>
<li>编辑任务类业务</li>
<li>任务分发</li>
<li>启动队列监控</li>
</ol>
<p><code>详细步骤</code></p>
<p>1.配置队列</p>
<blockquote>
<p>在使用之前必须安装redis软件</p>
</blockquote>
<p>安装redis队列驱动包</p>
<pre><code class="language-php">composer require &quot;predis/predis&quot;
</code></pre>
<p>.env</p>
<pre><code class="language-php">QUEUE_CONNECTION=redis
</code></pre>
<pre><code class="language-php">//redis配置
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
</code></pre>
<p>2.生成对列表</p>
<p>失败任务</p>
<p>有时候队列中的任务会失败。Laravel 内置了一个方便的方式来指定任务重试的最大次数。当任务超出这个重试次数后，它就会被插入到 failed_jobs 数据表里面。</p>
<pre><code class="language-php">//生成failed_jobs表
php artisan queue:failed-table
</code></pre>
<p>3.生成任务类</p>
<pre><code class="language-php">php artisan make:job TranslateSlug
</code></pre>
<p>4.修改任务类</p>
<blockquote>
<p>该类实现了 Illuminate\Contracts\Queue\ShouldQueue 接口，该接口表明 Laravel 应该将该任务添加到后台的任务队<br>
列中，而不是同步执行。</p>
<p>引入了 SerializesModels trait，Eloquent 模型会被优雅的序列化和反序列化。</p>
<p>handle 方法会在队列任务执行时被调用。</p>
<p>任务中要避免使用 Eloquent 模型接口调用，如： create() ,<br>
update() , save() 等操作。否则会陷入调用死循环--模型监控器分发任务，任务触发模型监控器，模型监控器再次分发任务，任务再次触发模型监控器.... 死循环。在这种情况下，使用 DB 类直接对数据库进行操作即可。</p>
</blockquote>
<p>5.任务分发</p>
<pre><code class="language-php">dispatch(new xxxjob($topic));
</code></pre>
<p>6.启动队列系统</p>
<p>php artisan queue:listen</p>
<h4 id="队列监控-horizon">队列监控 Horizon</h4>
<pre><code class="language-php">composer require laravel/horizon
</code></pre>
<blockquote>
<p>需要ext-pcntl 支持</p>
</blockquote>
<p><code>php artisan vendor:publish --provider=&quot;Laravel\Horizon\HorizonServiceProvide&quot;</code></p>
<h4 id="线上部署须知">线上部署须知</h4>
<ol>
<li>使用 Supervisor 进程工具进行管理，配置和使用请参照文档进行配置；</li>
<li>每一次部署代码时，需 artisan horizon:terminate 然后再 artisan horizon 重新加载代码。</li>
</ol>
<h2 id="第七章-帖子回复">第七章 帖子回复</h2>
<h3 id="tabs页面处理">tabs页面处理</h3>
<blockquote>
<p>基于 letrunghieu/active 插件</p>
</blockquote>
<h4 id="1active-类控制">1.active 类控制</h4>
<pre><code class="language-html">//href 传递一个tab参数,用于标志某个tabs
&lt;li class=&quot;nav-item&quot;&gt;
    &lt;a class=&quot;nav-link  bg-transparent {{active_class(if_query('tab',null))}}&quot; href=&quot;{{route('users.show',$user-&gt;id)}}&quot;&gt;Ta的话题&lt;/a&gt;
&lt;/li&gt;
&lt;li class=&quot;nav-item&quot;&gt;
    &lt;a class=&quot;nav-link {{active_class(if_query('tab','replies'))}}&quot; href=&quot;{{route('users.show',[$user-&gt;id,'tab'=&gt;'replies'])}}&quot;&gt;Ta的回复&lt;/a&gt;
&lt;/li&gt;
</code></pre>
<h4 id="2页面载入配置">2.页面载入配置</h4>
<pre><code class="language-php">@if(if_query('tab','replies'))
    {{--显示用户评论页--}}
    @include('ucenter.user._replies',['replies'=&gt;$user-&gt;reply()-&gt;with('topic')-&gt;recent()-&gt;paginate(5)])
@else
    {{--显示用户文章页--}}
    @include('ucenter.user._topics',['topics'=&gt;$user-&gt;topics()-&gt;recent()-&gt;paginate(5)])
@endif
</code></pre>
<h3 id="回复话题">回复话题</h3>
<pre><code class="language-html">//视条件加载子模板
@includeWhen($boolen,'view.name',['some'=&gt;'data'])
</code></pre>
<p>回复话题 ,回复数的增加 ReplyObserver 观察器</p>
<blockquote>
<p>比较严谨的做法是创建成功后计算本话题下评论总数, 然后在对其reply_count字段进行赋值。</p>
</blockquote>
<pre><code class="language-php">class ReplyObserver
{
     public function created(Reply $reply)
     {
         $reply-&gt;topic-&gt;reply_count = $reply-&gt;topic-&gt;replies-&gt;count();
         $reply-&gt;topic-&gt;save();
     }
}
</code></pre>
<h3 id="laravel-消息通知">laravel 消息通知</h3>
<h4 id="数据库通知知识">数据库通知知识</h4>
<ul>
<li>
<p>访问通知</p>
<p><code>$user-&gt;notifications</code></p>
</li>
<li>
<p>访问未读通知</p>
<p><code>$user-&gt;unreadNotifications</code></p>
</li>
<li>
<p>标记通知为已读</p>
<p><code>$user-&gt;markAsRead()</code></p>
</li>
<li>
<p>通知删除</p>
<p><code>$user-&gt;notifications()-&gt;delete();</code></p>
</li>
<li>
<p>获取data数据(json)</p>
<p><code>$notification-&gt;data['user_id']</code></p>
</li>
</ul>
<h4 id="通知频道">通知频道 :</h4>
<p>通知传播的途径, laravel自带的有数据库、邮件、短信以及slack</p>
<h4 id="数据库通知频道">数据库通知频道</h4>
<ol>
<li>
<p>创建表格</p>
<pre><code class="language-php">php artisan notifications:table

php artisan migrate
</code></pre>
</li>
</ol>
<p>我们还需要在users表里新增notification_count字段,用来追踪用户有多少未读通知,如果未读通知大于零的话,就在显示提醒</p>
<pre><code class="language-php">php artisan make:migration add_notification_count_to_users_table --table=users
</code></pre>
<ol start="2">
<li>
<p>生成通知类</p>
<pre><code class="language-php">php artisan make:notification RepliedNotice
</code></pre>
<pre><code class="language-php">&lt;?php
namespace App\Notifications;
use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Notifications\Messages\MailMessage;
use App\Models\Reply;
class RepliedNotice extends Notification
{
 use Queueable;
 public $reply;
 public function __construct(Reply $reply)
 {
 	// 注入回复实体，方便 toDatabase 方法中的使用
 	$this-&gt;reply = $reply;
 }
 public function via($notifiable)
 {
 	// 开启通知的频道
	 return ['database'];
 }
 public function toDatabase($notifiable)
 {
     $topic = $this-&gt;reply-&gt;topic;
     $link = $topic-&gt;link(['#reply' . $this-&gt;reply-&gt;id]);
     // 存入数据库里的数据
     return [
         'reply_id' =&gt; $this-&gt;reply-&gt;id,
         'reply_content' =&gt; $this-&gt;reply-&gt;content,
         'user_id' =&gt; $this-&gt;reply-&gt;user-&gt;id,
         'user_name' =&gt; $this-&gt;reply-&gt;user-&gt;name,
         'user_avatar' =&gt; $this-&gt;reply-&gt;user-&gt;avatar,
         'topic_link' =&gt; $link,
         'topic_id' =&gt; $topic-&gt;id,
         'topic_title' =&gt; $topic-&gt;title,
     ];
 }
}
</code></pre>
<blockquote>
<p>每个通知类都有个 via() 方法，它决定了通知在哪个频道上发送。我们写上 database 数据库来作为通知频道。<br>
因为使用数据库通知频道，我们需要定义 toDatabase() 。这个方法接收 $notifiable 实例参数并返回一个普通的<br>
PHP 数组。这个返回的数组将被转成 JSON 格式并存储到通知数据表的 data 字段中。</p>
</blockquote>
</li>
<li>
<p>通知执行流程</p>
</li>
</ol>
<figure data-type="image" tabindex="2"><img src="assets/1552309644161.png" alt="1552309644161" loading="lazy"></figure>
<ol start="4">
<li>通知阅读流程</li>
</ol>
<figure data-type="image" tabindex="3"><img src="assets/1552477894134.png" alt="1552477894134" loading="lazy"></figure>
<h4 id="邮件通知">邮件通知</h4>
<p>// app\Notifications\RepiedNotice.php 通知类</p>
<pre><code class="language-php">Class RepiedNotice extends Notification
{
    public function __construct(Repied $reply)
    {
        $this-&gt;reply=$reply;
    }
    
    public function via($notifiable)
    {
        return ['databse','mail'];
    }
    
    public function toMail($notifiable)
    {
        $url=$this-&gt;reply-&gt;topic-link(['#reply',$this-&gt;reply-&gt;id]);
        return (new MailMessage)-&gt;subject('邮件标题')-&gt;line('你的话题有新回复')-&gt;action('查看回复',$url);
    }
}
</code></pre>
<h4 id="消息邮件加入队列">消息邮件加入队列</h4>
<p>我们可以通过对通知类添加 ShouldQueue 接口和 Queueable trait 把通知加入队列。它们两个在使用<br>
make:notification 命令来生成通知文件时就已经被导入，我们只需添加到通知类接口即可。</p>
<p>修改 TopicReplied.php 文件，将以下这一行：</p>
<pre><code class="language-php">class TopicReplied extends Notification
</code></pre>
<p>改为：</p>
<pre><code class="language-php">class TopicReplied extends Notification implements ShouldQueue
</code></pre>
<p>Laravel 会检测 ShouldQueue 接口并自动将通知的发送放入队列中，所以我们不需要做其他修改。</p>
<h2 id="第八章-用户权限">第八章 用户权限</h2>
<h3 id="权限扩展包permission">权限扩展包permission</h3>
<p><code>spatie/laravel-permission</code></p>
<h4 id="使用规范">使用规范</h4>
<p>user模型加载HasRoles trait</p>
<pre><code class="language-php">use Spatie\Permission\Traits\HasRoles;
class User extends Authenticatable implements MustVerifyEmailContract
{
 use HasRoles;
}
</code></pre>
<p>权限定义规范我们统一只用_分割法</p>
<table>
<thead>
<tr>
<th>权限</th>
<th>命名</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>内容管理</td>
<td>manage_contents</td>
<td></td>
</tr>
<tr>
<td>用户管理</td>
<td>manage_users</td>
<td></td>
</tr>
<tr>
<td>站点设置</td>
<td>edit_settings</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="站点权限部署">站点权限部署</h4>
<p><strong>策略过滤器</strong></p>
<blockquote>
<p>代码生成器所生成的策略授权,都会统一集成App\Policies\Policy基类,这样我们只需要在基类的before()方法里做下角色权限判断即可坐拥到所有的授权类</p>
</blockquote>
<pre><code class="language-php">public function before($user, $ability)
{
    if($user-&gt;can('manage_contens')){
        return true;
    }
}
</code></pre>
<h4 id="gates-说明">Gates 说明</h4>
<p>授权操作主要有两种方式:gates和策略.</p>
<p>Gates大部分应用在模型和资源没有关系的地方,比如查看管理员的面板.与之相反, 策略应该在特定的模型或者资源中使用.</p>
<p>Horizon 访问权限的设置</p>
<blockquote>
<p>下面代码只有角色为Founder的才能访问horizon面板</p>
</blockquote>
<p>AuthServiceProvider.php</p>
<pre><code class="language-php">    public function boot()
    {
        $this-&gt;registerPolicies();
        //Horizon 访问权限设置
        \Horizon::auth(function ($request) {
            // 是否是站长,这里需要先判断是否登录
            if(!\Auth::check()) return false;
            return \Auth::user()-&gt;hasRole('Founder');
        });
    }
</code></pre>
<h3 id="管理后台包">管理后台包</h3>
<p><code>summerblue/administrator</code></p>
<h4 id="laravel58采坑安装">laravel5.8采坑安装</h4>
<p>https://learnku.com/laravel/t/18675</p>
<blockquote>
<p>错误信息: In AdministratorServiceProvider.php line 48:</p>
<p>Call to undefined method Illuminate\Events\Dispatcher::fire()</p>
<p>解决方法: 搜索AdministratorServiceProvier.php文件按照下面修改fire()方法为dispatch();</p>
<p><a href="https://github.com/latifasaee">@latifasaee</a> In short, when you see an error like this with Laravel 5.8, the call</p>
<pre><code>Call to undefined method Illuminate\Events\Dispatcher::fire() 
</code></pre>
<p>needs to be changed to</p>
<pre><code>Call to undefined method Illuminate\Events\Dispatcher::dispatch() 
</code></pre>
<p>In versions prior to Laravel 5.7, this method classname was <code>fire</code> but with Laravel 5.8, it is now <code>dispatch</code></p>
</blockquote>
<h3 id="用户切换工具sudo-su">用户切换工具sudo-su</h3>
<ol>
<li>
<p>安装插件</p>
<p><code>viacreative/sudo-su</code></p>
</li>
<li>
<p>修改配置文件</p>
<pre><code class="language-php">config/sudosu.php
    //域名后缀限制
'allowed_tlds' =&gt; ['dev', 'local','com'],  
'user_model' =&gt; App\Models\User::class
</code></pre>
</li>
<li>
<p>模板植入</p>
<pre><code class="language-php">//resources/views/layouts/app.blade.php
@if (config('app.debug'))
    @include('sudosu::user-selector')
@endif
</code></pre>
</li>
</ol>
<h3 id="管理后台包-2">管理后台包</h3>
<p>插件: <code>summerblue/administrator</code></p>
<p>创建必要的文件夹</p>
<p>Administrator 会检测<code>model_config_path</code>和 <code>settings_config_path</code>目录是否能正常访问,所以我们需要先新建目录</p>
<pre><code class="language-php">$ mkdir -p config/administrator/settings
$ touch config/administrator/settings/.gitkeep
</code></pre>
<p>在空文件夹中放置 .gitkeep 保证了 Git 会将此文件夹纳入版本控制器中。</p>
<p>bug解决</p>
<p><code>Administrator: 在 administrator.php 的配置中你必须提供一个有效的 'home_page' 参数</code></p>
<p>解决:</p>
<p>https://github.com/summerblue/administrator-demo/blob/master/config/administrator/users.php</p>
<p>将users.php复制到config/administrator/目录下</p>
<p>修改use App\User 为use App\Models\User;</p>
<p>配置文章</p>
<p>https://learnku.com/laravel/t/2407/use-laravel-administrator-to-quickly-generate-data-model-administrator-tutorial</p>
<h2 id="第九章-杂项">第九章 杂项</h2>
<h3 id="边栏活跃用户">边栏活跃用户</h3>
<h4 id="新建artisan-命令">新建artisan 命令</h4>
<pre><code class="language-php">php artisan make:command CalculateActiveUser --command=larabbs:calculate-active-user
</code></pre>
<p>参数<code>--command</code>是指定artisan调用的命令,一般情况下,我们推介为命令加上命名空间,如本项目的<code>larabbs</code></p>
<h4 id="计划任务">计划任务</h4>
<blockquote>
<p>laravel 的计划任务执行思路</p>
<ol>
<li>
<p>在系统的crontab中 先执行schedule:run 命令</p>
</li>
<li>
<p>在app/Console/Kernel.php的schedule方法中定义相关命令</p>
</li>
</ol>
</blockquote>
<p><strong>1.系统cron定义laravel 计划任务命令</strong></p>
<p>修改系统的Cron计划任务配置信息,运行以下命令</p>
<pre><code class="language-php">$ export EDITOR=vi &amp;&amp; crontab -e
</code></pre>
<p>复制下面的这一行</p>
<pre><code class="language-php">* * * * * php /home/vagrant/Code/larabbs/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1
</code></pre>
<p>2.在<code>app/Console/Kernel.php</code>文件的<code>schedule</code>方法中定义</p>
<pre><code class="language-php">protected function schedule(Schedule $schedule)
 {
 // 一小时执行一次『活跃用户』数据生成的命令
 $schedule-&gt;command('larabbs:calculate-active-user')-&gt;hourly();
 }
</code></pre>
<p>系统的Cron已经设定好了,现在Cron软件将会每分钟调用一次laravel命令调度器,当<code>achedule:run</code>命令执行时,laravel会评估你的计划任务并运行预定任务.</p>
<h3 id="热门文章">热门文章</h3>
<p><code>Cache::remember()</code></p>
<pre><code class="language-php">class Link extends Model
{
    protected $fillable = ['title', 'link'];
    public $cache_key = 'larabbs_links';
    protected $cache_expire_in_minutes = 1440;
    public function getLinkCache()
    {
// 尝试从缓存中取出 cache_key 对应的数据。如果能取到，便直接返回数据。
// 否则运行匿名函数中的代码来取出活跃用户数据，返回的同时做了缓存。
        return \Cache::remember($this-&gt;cache_key, $this-&gt;cache_expire_in_minutes, function(){
            return $this-&gt;all();
        });
    }
}
</code></pre>
<p><code>Cache::forget()</code></p>
<h3 id="避免数据损坏">避免数据损坏</h3>
<blockquote>
<p>我们删除了用户,却没有删除用户发布的话题,此部分话题变成了遗留数据. 话题列表中渲染到这些遗留数据时,因为不存在作者,却取作者的avatar头像属性,故报错.</p>
</blockquote>
<p>处理办法,实现关联数据的删除.</p>
<h4 id="两种处理机制">两种处理机制:</h4>
<ol>
<li>代码监听器 —— 利用 的 deleted 事件连带删除，好处是灵活、扩展性强，不受底层数据库约束，坏处当删除时不添加监听器，就会出现漏删；</li>
<li>外键约束 —— 利用 MySQL 自带的外键约束功能，好处是数据一致性强，基本上不会出现漏删，坏处是有些数据库不支持，如 SQLite。</li>
</ol>
<h4 id="添加外检约束">添加外检约束</h4>
<blockquote>
<p>这里的外键约束，数据库引擎一定要是 InnoDB 类型的。MyISAM 类型不支持外键约束</p>
</blockquote>
<p>1.当用户删除时,删除其发布的话题;</p>
<p>2.当用户删除时,删除其发布的回复;</p>
<p>3.当话题删除时,删除其所属的回复;</p>
<blockquote>
<p>on update和on delete后面可以跟的词语有四个<br>
no action ， set null ， set default ，cascade<br>
no action 表示 不做任何操作，<br>
set null 表示在外键表中将相应字段设置为null<br>
set default 表示设置为默认值<br>
cascade 表示级联操作，就是说，如果主键表中被参考字段更新，外键表中也更新，主键表中的记录被删除，外键表中改行也相应删除</p>
</blockquote>
<pre><code class="language-php">public function up()
    {

        Schema::table('topics',function(Blueprint $table){
            $table-&gt;foreign('user_id')-&gt;references('id')-&gt;on('users')-&gt;onDelete('cascade');
        });

        Schema::table('replies',function(Blueprint $table){
            $table-&gt;foreign('user_id')-&gt;references('id')-&gt;on('users')-&gt;onDelete('cascade');
            $table-&gt;foreign('topic_id')-&gt;references('id')-&gt;on('topics')-&gt;onDelete('cascade');
        });
}
</code></pre>
<h3 id="用户最后登录时间">用户最后登录时间</h3>
<p>数据库题外话:</p>
<blockquote>
<p>然而，在数据库中操作中，『写入』对数据库造成的压力，要远比『读取』压力高得多。想要准确地跟踪用户的最后活跃时间，就必须在用户每一次请求服务器时都做记录，我们使用的主数据是 MySQL，也就是说每当用户访问一个页面，我们都将 MySQL 数据库里的 users 表写入数据。当我们有很多用户频繁访问站点时，这将会是数据库的一笔巨大开销。<br>
我们可以使用 Redis 来记录用户的访问时间，Redis 运行在机器的内存上，读写效率都极快。不过为了保证数据的完整性，我们需要定期将 Redis 数据同步到数据库中，否则一旦 Redis 出问题或者执行了 Redis 清理操作，用户的『最后活跃时间』将会丢失</p>
</blockquote>
<hr>
<h4 id="基本思路">基本思路</h4>
<p><code>基本思路如下</code>：</p>
<ol>
<li>记录 - 通过中间件过滤用户所有请求，记录用户访问时间到 Redis 按日期区分的哈希表；</li>
<li>同步 - 新建命令，计划任务每天运行一次此命令，将昨日哈希表里的数据同步到数据库中，并删除；</li>
<li>读取 - 优先读取当日哈希表里 Redis 里的数据，无数据则使用数据库中的值。</li>
</ol>
<h4 id="前置中间件和后置中间件">前置中间件和后置中间件</h4>
<blockquote>
<p>前置中间件是应用初始化完成以后立刻执行，此时控制器路由还未分配、控制器还未执行、视图还未渲染。后置中间件是即将离开应用的响应，此时控制器已将渲染好的视图返回，我们可以在后置中间件里修改响应。</p>
</blockquote>
<ol>
<li>创建中间件</li>
</ol>
<pre><code class="language-php">php artisan make:middleware RecordLastActived
</code></pre>
<ol start="2">
<li>
<p>注册中间件:在app/Http/Kernel.php类中对中间件进行注册</p>
</li>
<li>
<p>书写中间件</p>
<pre><code class="language-php">class RecordLastActivedTime
{
public function handle($request, Closure $next)
    {
        //如果是登录用户的话
        if(\Auth::check()){
            //    记录最后登录时间
            \Auth::user()-&gt;recordLastActivedAt();
        }
        return $next($request);
    }
}
</code></pre>
</li>
</ol>
<h3 id="总结-缓存操作">总结: 缓存操作</h3>
<h4 id="常用缓存操作">常用缓存操作</h4>
<pre><code class="language-php">//取出缓存,如果不存在则执行function闭包函数中的内容
Cache::remember(key,expired,function(){	
​	return .....
})
//将数据放入缓存中
Cache::put(key,value,expired);
//清除缓存值
Cache::forget(key);
    
</code></pre>
<h4 id="redis-操作">redis 操作</h4>
<pre><code class="language-第php">//$hash 表名, $filed 字段名,$value 字段值
Redis::hset($hash,$field,$value);
</code></pre>
<h2 id="第十章-附注">第十章 附注</h2>
<h3 id="删除按钮policy-优化">删除按钮policy 优化</h3>
<blockquote>
<p>解决文章评论列表删除按钮显示的policy判断,处理方法,在数据分配的时候讲相关模型懒加载.</p>
</blockquote>
<pre><code class="language-php">@include('topics._reply_list',['replies'=&gt;$topic-&gt;reply()-&gt;with('user','topic')-&gt;get()])
</code></pre>
<p>模板中代码</p>
<pre><code class="language-php">@if(count($replies)&gt;0)
    &lt;ul class=&quot;list-group&quot;&gt;
    @foreach($replies as $reply)
    &lt;li class=&quot;list-group-item&quot;&gt;
    &lt;div&gt;{{$reply-&gt;user-&gt;name}}
&lt;i class=&quot;far fa-clock&quot;&gt;&lt;/i&gt; {{$reply-&gt;created_at-&gt;diffForHumans()}}
&lt;/div&gt;
    &lt;div&gt;{{$reply-&gt;content}}&lt;/div&gt;
{{--@can('delete',$reply)--}}
&lt;div class=&quot;text-right&quot;&gt;
    &lt;form action=&quot;{{route('replies.destroy',$reply-&gt;id)}}&quot; method=&quot;post&quot;&gt;
    @csrf
{{method_field('delete')}}
&lt;button type=&quot;submit&quot; class=&quot;btn btn-outline-secondary&quot;&gt;删除&lt;/button&gt;
    &lt;/form&gt;
    &lt;/div&gt;
{{--@endcan--}}
&lt;/li&gt;
    @endforeach
    &lt;/ul&gt;
    @endif

</code></pre>
<h3 id="bootstrap4-flex弹性布局">bootstrap4 flex(弹性)布局</h3>
<pre><code class="language-php">.ml-md-auto 产生效果右对齐,垂直居中
</code></pre>
<h3 id="电子邮箱设置注意">电子邮箱设置注意</h3>
<blockquote>
<p>需要配置, 否则可能出错</p>
<p>MAIL_FROM_ADDRESS=9175020@qq.com<br>
MAIL_FROM_NAME=larabbs</p>
</blockquote>

        </div>
        <!-- Share to Twitter, Weibo, Telegram -->
        <div class="flex items-center">
          <div class="mr-4 flex items-center">
            <i class="ri-share-forward-line text-gray-500"></i>
          </div>
          <div class="px-4 cursor-pointer text-blue-500 hover:bg-blue-100 dark:hover:bg-gray-600 inline-flex" @click="shareToTwitter">
            <i class="ri-twitter-line"></i>
          </div>
          <div class="px-4 cursor-pointer text-red-500 hover:bg-red-100 dark:hover:bg-gray-600 inline-flex" @click="shareToWeibo">
            <i class="ri-weibo-line"></i>
          </div>
          <div class="px-4 cursor-pointer text-indigo-500 hover:bg-indigo-100 dark:hover:bg-gray-600 inline-flex" @click="shareToTelegram">
            <i class="ri-telegram-line"></i>
          </div>
        </div>
      </div>

      

      

      <footer class="py-12 text-center px-4 md:px-0" v-pre>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
</footer>
    </div>

    <!-- TOC Container -->
    <div class="fixed right-0 bottom-0 mb-16 mr-4 shadow w-8 h-8 rounded-full flex justify-center items-center z-10 cursor-pointer bg-white dark:bg-gray-500 dark:text-gray-200 hover:shadow-lg transition-all animated fadeInRight" @click="showToc = true">
      <i class="ri-file-list-line"></i>
    </div>

    <div class="fixed right-0 top-0 bottom-0 overflow-y-auto w-64 bg-white dark:bg-gray-800 p-4 border-l border-gray-100 dark:border-gray-600 z-10 transition-fast" :class="{ '-mr-64': !showToc }">
      <div class="flex mb-4 justify-end">
        <div class="w-8 h-8 inline-flex justify-center items-center rounded-full cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-fast" @click="showToc = false">
          <i class="ri-close-line text-lg"></i>
        </div>
      </div>
      <div class="post-toc-container">
        <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E6%B1%87%E6%80%BB%E7%9F%A5%E8%AF%86">汇总知识</a>
<ul>
<li><a href="#%E6%A8%A1%E5%9E%8B%E5%85%B3%E8%81%94%E6%8B%AC%E5%8F%B7">模型关联括号</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%88%9E%E5%8F%B0%E5%B8%83%E7%BD%AE">第二章: 舞台布置</a>
<ul>
<li><a href="#%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87">字体图标</a>
<ul>
<li><a href="#%E8%BD%BD%E5%85%A5%E6%A0%B7%E5%BC%8F">载入样式</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83">第三章: 用户中心</a>
<ul>
<li><a href="#guest%E4%BD%BF%E7%94%A8">@guest使用</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81%E7%A0%81">验证码</a></li>
<li><a href="#%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81">邮箱验证</a></li>
<li><a href="#%E4%BA%8B%E4%BB%B6%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B">事件和监听器基本流程</a>
<ul>
<li><a href="#%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95">存放目录</a></li>
<li><a href="#%E6%B3%A8%E5%86%8C%E4%BA%8B%E4%BB%B6%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8">注册事件和监听器</a></li>
<li><a href="#%E7%94%9F%E6%88%90%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8">生成事件&amp;监听器</a></li>
<li><a href="#%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8">定义事件和监听器</a></li>
<li><a href="#%E5%88%86%E5%8F%91%E4%BA%8B%E4%BB%B6">分发事件</a></li>
</ul>
</li>
<li><a href="#%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%8F%90%E7%A4%BA">密码重置提示</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83">第四章: 用户中心</a>
<ul>
<li><a href="#unique-%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99">unique 验证规则</a></li>
<li><a href="#%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E5%8F%8B%E5%A5%BD%E6%97%B6%E9%97%B4%E6%88%B3">中文显示友好时间戳</a></li>
<li><a href="#%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0">头像上传</a>
<ul>
<li><a href="#%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99">图片验证规则</a></li>
<li><a href="#%E8%A3%81%E5%89%AA%E5%9B%BE%E7%89%87">裁剪图片</a></li>
</ul>
</li>
<li><a href="#%E4%B8%AA%E4%BA%BA%E8%B5%84%E6%96%99%E7%BC%96%E8%BE%91%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">个人资料编辑存在的问题</a>
<ul>
<li><a href="#1-%E6%B8%B8%E5%AE%A2%E9%99%90%E5%88%B6">1. 游客限制</a></li>
<li><a href="#2%E4%BF%AE%E6%94%B9%E5%88%AB%E4%BA%BA%E7%9A%84%E8%B5%84%E6%96%99%E5%B9%B3%E8%A1%8C%E6%9D%83%E9%99%90">2.修改别人的资料(平行权限)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-%E5%B8%96%E5%AD%90%E5%88%97%E8%A1%A8">第五章 帖子列表</a>
<ul>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE">初始化数据</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8">代码生成器</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B">使用案例</a></li>
<li><a href="#%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81">生成的代码</a></li>
</ul>
</li>
<li><a href="#git-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B">git 使用案例</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%A1%AB%E5%85%85">数据填充</a>
<ul>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%A1%AB%E5%85%85%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B">数据填充的基本流程</a></li>
</ul>
</li>
<li><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD">懒加载</a></li>
<li><a href="#%E6%A0%87%E9%A2%98%E6%A8%A1%E6%9D%BF%E4%B8%89%E5%85%83%E8%A1%A8%E8%BE%BE%E5%BC%8F">标题模板三元表达式</a></li>
<li><a href="#%E5%AF%BC%E8%88%AA%E6%A0%8F-active-%E7%B1%BB%E8%AE%BE%E7%BD%AE">导航栏 active 类设置</a>
<ul>
<li><a href="#%E6%8F%92%E4%BB%B6%E5%90%8D%E7%A7%B0">插件名称</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95">基础语法</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-2">使用案例</a></li>
</ul>
</li>
<li><a href="#%E6%A8%A1%E6%9D%BFinclude%E5%8F%98%E9%87%8F%E5%88%86%E9%85%8D">模板include变量分配</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%B8%96%E5%AD%90curd">第六章 帖子CURD</a>
<ul>
<li><a href="#%E6%A8%A1%E5%9E%8B%E8%A7%82%E5%AF%9F%E5%99%A8%E5%A4%84%E7%90%86%E6%91%98%E8%A6%81">模型观察器处理摘要</a>
<ul>
<li><a href="#eloquent-%E4%BA%8B%E4%BB%B6">Eloquent 事件</a></li>
<li><a href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">应用场景</a></li>
</ul>
</li>
<li><a href="#simditor-%E7%BC%96%E8%BE%91%E5%99%A8">Simditor 编辑器</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85">安装</a></li>
<li><a href="#%E5%8A%A0%E8%BD%BD">加载</a></li>
<li><a href="#%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0">图片上传</a></li>
</ul>
</li>
<li><a href="#xss-%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E">xss 安全漏洞</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85-2">安装</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8">使用</a></li>
<li><a href="#xss-%E6%B3%A8%E5%85%A5%E6%B5%8B%E8%AF%95">xss 注入测试</a></li>
</ul>
</li>
<li><a href="#seo-%E5%8F%8B%E5%A5%BD%E7%9A%84url">seo 友好的url</a>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6">安装的插件</a></li>
<li><a href="#%E6%B3%A8%E5%86%8C%E7%99%BE%E5%BA%A6%E7%BF%BB%E8%AF%91%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0">注册百度翻译开放平台</a></li>
<li><a href="#%E7%BF%BB%E8%AF%91%E8%B0%83%E7%94%A8">翻译调用</a></li>
</ul>
</li>
<li><a href="#laravel%E9%98%9F%E5%88%97">laravel队列</a>
<ul>
<li><a href="#%E9%98%9F%E5%88%97%E6%AD%A5%E9%AA%A4">队列步骤</a></li>
<li><a href="#%E9%98%9F%E5%88%97%E7%9B%91%E6%8E%A7-horizon">队列监控 Horizon</a></li>
<li><a href="#%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2%E9%A1%BB%E7%9F%A5">线上部署须知</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E5%B8%96%E5%AD%90%E5%9B%9E%E5%A4%8D">第七章 帖子回复</a>
<ul>
<li><a href="#tabs%E9%A1%B5%E9%9D%A2%E5%A4%84%E7%90%86">tabs页面处理</a>
<ul>
<li><a href="#1active-%E7%B1%BB%E6%8E%A7%E5%88%B6">1.active 类控制</a></li>
<li><a href="#2%E9%A1%B5%E9%9D%A2%E8%BD%BD%E5%85%A5%E9%85%8D%E7%BD%AE">2.页面载入配置</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9E%E5%A4%8D%E8%AF%9D%E9%A2%98">回复话题</a></li>
<li><a href="#laravel-%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5">laravel 消息通知</a>
<ul>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%9A%E7%9F%A5%E7%9F%A5%E8%AF%86">数据库通知知识</a></li>
<li><a href="#%E9%80%9A%E7%9F%A5%E9%A2%91%E9%81%93">通知频道 :</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%9A%E7%9F%A5%E9%A2%91%E9%81%93">数据库通知频道</a></li>
<li><a href="#%E9%82%AE%E4%BB%B6%E9%80%9A%E7%9F%A5">邮件通知</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E9%82%AE%E4%BB%B6%E5%8A%A0%E5%85%A5%E9%98%9F%E5%88%97">消息邮件加入队列</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90">第八章 用户权限</a>
<ul>
<li><a href="#%E6%9D%83%E9%99%90%E6%89%A9%E5%B1%95%E5%8C%85permission">权限扩展包permission</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83">使用规范</a></li>
<li><a href="#%E7%AB%99%E7%82%B9%E6%9D%83%E9%99%90%E9%83%A8%E7%BD%B2">站点权限部署</a></li>
<li><a href="#gates-%E8%AF%B4%E6%98%8E">Gates 说明</a></li>
</ul>
</li>
<li><a href="#%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E5%8C%85">管理后台包</a>
<ul>
<li><a href="#laravel58%E9%87%87%E5%9D%91%E5%AE%89%E8%A3%85">laravel5.8采坑安装</a></li>
</ul>
</li>
<li><a href="#%E7%94%A8%E6%88%B7%E5%88%87%E6%8D%A2%E5%B7%A5%E5%85%B7sudo-su">用户切换工具sudo-su</a></li>
<li><a href="#%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E5%8C%85-2">管理后台包</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E6%9D%82%E9%A1%B9">第九章 杂项</a>
<ul>
<li><a href="#%E8%BE%B9%E6%A0%8F%E6%B4%BB%E8%B7%83%E7%94%A8%E6%88%B7">边栏活跃用户</a>
<ul>
<li><a href="#%E6%96%B0%E5%BB%BAartisan-%E5%91%BD%E4%BB%A4">新建artisan 命令</a></li>
<li><a href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1">计划任务</a></li>
</ul>
</li>
<li><a href="#%E7%83%AD%E9%97%A8%E6%96%87%E7%AB%A0">热门文章</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F">避免数据损坏</a>
<ul>
<li><a href="#%E4%B8%A4%E7%A7%8D%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6">两种处理机制:</a></li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E5%A4%96%E6%A3%80%E7%BA%A6%E6%9D%9F">添加外检约束</a></li>
</ul>
</li>
<li><a href="#%E7%94%A8%E6%88%B7%E6%9C%80%E5%90%8E%E7%99%BB%E5%BD%95%E6%97%B6%E9%97%B4">用户最后登录时间</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF">基本思路</a></li>
<li><a href="#%E5%89%8D%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%92%8C%E5%90%8E%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6">前置中间件和后置中间件</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93-%E7%BC%93%E5%AD%98%E6%93%8D%E4%BD%9C">总结: 缓存操作</a>
<ul>
<li><a href="#%E5%B8%B8%E7%94%A8%E7%BC%93%E5%AD%98%E6%93%8D%E4%BD%9C">常用缓存操作</a></li>
<li><a href="#redis-%E6%93%8D%E4%BD%9C">redis 操作</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E9%99%84%E6%B3%A8">第十章 附注</a>
<ul>
<li><a href="#%E5%88%A0%E9%99%A4%E6%8C%89%E9%92%AEpolicy-%E4%BC%98%E5%8C%96">删除按钮policy 优化</a></li>
<li><a href="#bootstrap4-flex%E5%BC%B9%E6%80%A7%E5%B8%83%E5%B1%80">bootstrap4 flex(弹性)布局</a></li>
<li><a href="#%E7%94%B5%E5%AD%90%E9%82%AE%E7%AE%B1%E8%AE%BE%E7%BD%AE%E6%B3%A8%E6%84%8F">电子邮箱设置注意</a></li>
</ul>
</li>
</ul>
</li>
</ul>

      </div>
    </div>

    <!-- Back to top -->
    <div class="fixed right-0 bottom-0 mb-4 mr-4 shadow w-8 h-8 rounded-full flex justify-center items-center z-10 cursor-pointer bg-white hover:shadow-lg transition-all dark:bg-gray-500 dark:text-gray-200" @click="backToUp" v-show="scrolled">
      <i class="ri-arrow-up-line"></i>
    </div>
  </div>

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
        It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg">
  </div>
  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item">
      </div>
      <div class="pswp__item">
      </div>
      <div class="pswp__item">
      </div>
    </div>
    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->
        <div class="pswp__counter">
        </div>
        <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
        <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
        <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip">
        </div>
      </div>
      <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
      </button>
      <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
      </button>
      <div class="pswp__caption">
        <div class="pswp__caption__center">
        </div>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://bluegrasses.github.io/media/scripts/main.js"></script>
  
  <!-- Code Highlight -->
  
    <script src="https://bluegrasses.github.io/media/prism.js"></script>
    <script>
      Prism.highlightAll()
    </script>
  

  <script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>
  <script>
    //拿到预览框架，也就是上面的html代码
    var pswpElement = document.querySelectorAll('.pswp')[0];
    //定义图片数组变量
    var imgitems;
    /**
    * 用于显示预览界面
    * @param index 图片数组下标
    */
    function viewImg(index) {
      //其它选项这里不做过多阐述，详情见官网
      var pswpoptions = {
        index: parseInt(index, 10), // 开始幻灯片索引。0是第一张幻灯片。必须是整数，而不是字符串。
        bgOpacity: 0.7, // 背景透明度，0-1
        maxSpreadZoom: 3, // 缩放级别，不要太大
      };
      //初始化并打开PhotoSwipe，pswpElement对应上面预览框架，PhotoSwipeUI_Default为皮肤，imgitems为图片数组，pswpoptions为选项
      var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, imgitems, pswpoptions);
      gallery.init()
    }
    /**
    * 用于添加图片点击事件
    * @param img 图片元素
    * @param index 所属下标（在imgitems中的位置）
    */
    function addImgClick(img, index) {
      img.onclick = function() {
        viewImg(index)
      }
    }
    /**
    * 轮询所有图片，获取src、width、height等数据，加入imgitems，并给图片元素添加事件
    * 最好在onload中执行该方法，本站因放在最底部，所以直接初始化
    * 异步加载图片可在图片元素创建完成后调用此方法
    */
    function initImg() {
      //重置图片数组
      imgitems = [];
      //查找class:markdown 下的所有img元素并遍历
      var imgs = document.querySelectorAll('.markdown img');
      for (var i = 0; i < imgs.length; i++) {
        var img = imgs[i];
        //本站相册初始为loading图片，真实图片放在data-src
        var ds = img.getAttribute("data-src");
        //创建image对象，用于获取图片宽高
        var imgtemp = new Image();
        //判断是否存在data-src
        if (ds != null && ds.length > 0) {
          imgtemp.src = ds
        } else {
          imgtemp.src = img.src
        }
        //判断是否存在缓存
        if (imgtemp.complete) {
          var imgobj = {
            "src": imgtemp.src,
            "w": imgtemp.width,
            "h": imgtemp.height,
          };
          imgitems[i] = imgobj;
          addImgClick(img, i);
        } else {
          console.log('进来了2')
          imgtemp.index = i;
          imgtemp.img = img;
          imgtemp.onload = function() {
            var imgobj = {
              "src": this.src,
              "w": this.width,
              "h": this.height,
            };
            //不要使用push，因为onload前后顺序会不同
            imgitems[this.index] = imgobj
            //添加点击事件
            addImgClick(this.img, this.index);
          }
        }
      }
    }
    //初始化
    initImg();
  </script>
  
  
</body>

</html>